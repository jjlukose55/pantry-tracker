<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grist Food Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        input, button, select { border-radius: 8px; border: 1px solid #d1d5db; }
        button { transition: background-color 0.3s, transform 0.1s; }
        button:hover { transform: translateY(-1px); }
        table { border-collapse: separate; border-spacing: 0; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
        th, td { border: 0; padding: 12px; }
        th { background-color: #f3f4f6; text-transform: uppercase; font-weight: 600; color: #4b5563; }
        td { border-bottom: 1px solid #e5e7eb; }
        tr:last-child td { border-bottom: 0; }
        .edit-btn { background-color: #f97316; }
        .delete-btn { background-color: #ef4444; }
        .save-btn { background-color: #22c55e; }
        .cancel-btn { background-color: #6b7280; }
        .message-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); z-index: 1000; }
        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; }
        .dropdown-list { position: absolute; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-height: 150px; overflow-y: auto; z-index: 100; top: 100%; left: 0; right: 0; border: 1px solid #d1d5db; }
        .dropdown-item { padding: 8px 12px; cursor: pointer; }
        .dropdown-item:hover { background-color: #f3f4f6; }
        .form-field { display: flex; flex-direction: column; }
        #chat-container { border: 1px solid #d1d5db; border-radius: 8px; padding: 1rem; }
        #chat-messages { height: 200px; overflow-y: auto; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-bubble { padding: 0.5rem 1rem; border-radius: 1rem; max-width: 80%; }
        .user-bubble { background-color: #3b82f6; color: white; align-self: flex-end; }
        .ai-bubble { background-color: #e5e7eb; color: #1f2937; align-self: flex-start; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="container mt-10">
        <h1 class="text-4xl font-bold text-center mb-2">Grist Food Tracker üçé</h1>
        <p class="text-center text-gray-600 mb-6">A simple app to track food items at home.</p>

        <!-- === TAB NAVIGATION === -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-8" aria-label="Tabs">
                <!-- Tab 1: Add Item (Default Active) -->
                <button class="tab-btn flex-1 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600" data-page="add">
                    Add Item
                </button>
                <!-- Tab 2: Pantry List -->
                <button class="tab-btn flex-1 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-page="list">
                    Pantry List
                </button>
                <!-- Tab 3: Pantry Assistant -->
                <button class="tab-btn flex-1 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-page="chat">
                    Pantry Assistant
                </button>
            </nav>
        </div>
        <!-- === END TAB NAVIGATION === -->

        <div id="message-container"></div>
        
        <!-- === PAGE 1: ADD ITEM (Visible by default) === -->
        <div id="page-add" class="page-content">
            <h2 class="text-2xl font-bold text-center mb-4">Add New Item</h2>
            <form id="addItemForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                
                <!-- === AI TOGGLE === -->
                <div class="form-field lg:col-span-4 flex flex-row items-center justify-between py-2">
                    <label for="aiToggle" class="block text-sm font-medium text-gray-700">Enable AI Recognition</label>
                    <button type="button" id="aiToggleBtn" class="bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" role="switch" aria-checked="false">
                        <span class="sr-only">Enable AI Recognition</span>
                        <input type="checkbox" id="aiToggle" class="hidden"> <!-- Off by default -->
                        <span id="aiToggleHandle" aria-hidden="true" class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                    </button>
                </div>

                <!-- === IMAGE UPLOAD FIELD === -->
                <div class="form-field lg:col-span-4">
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-1">Take Item Photo</label>
                    <!-- No longer disabled -->
                    <input type="file" id="imageUpload" accept="image/*" capture="environment" class="p-2 w-full border-gray-300 rounded-lg">
                    <p id="ai-status" class="text-xs text-gray-500 h-4"></p>
                </div>

                <div class="form-field">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="name" placeholder="e.g., Apples" required class="p-2">
                </div>
                <div class="form-field">
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" id="quantity" placeholder="e.g., 1" min="1" required class="p-2">
                </div>
                <div class="form-field">
                    <label for="owner" class="block text-sm font-medium text-gray-700 mb-1">Owner</label>
                    <input type="text" id="owner" placeholder="e.g., Justin" required class="p-2">
                </div>
                <div class="form-field">
                    <label for="locationSelect" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <select id="locationSelect" required class="p-2 w-full"></select>
                </div>
                <div class="form-field">
                    <label for="insertion" class="block text-sm font-medium text-gray-700 mb-1">Insertion Date</label>
                    <input type="date" id="insertion" required class="p-2 w-full">
                </div>
                <div class="form-field">
                    <label for="expiration" class="block text-sm font-medium text-gray-700 mb-1">Expiration Date</label>
                    <input type="date" id="expiration" required class="p-2 w-full">
                </div>
                <button type="submit" class="lg:col-span-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 mt-4">Add Item</button>
            </form>
        </div>
        <!-- === END PAGE 1 === -->


        <!-- === PAGE 2: PANTRY LIST (Hidden by default) === -->
        <div id="page-list" class="page-content hidden">
            <hr class="my-6">
            <h2 class="text-2xl font-bold text-center mb-4">Food Items</h2>
            
            <div class="mb-4">
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Search by Name</label>
                <input type="text" id="searchInput" placeholder="Search..." class="p-2 w-full border-gray-300 rounded-lg">
            </div>

            <div class="flex justify-center mb-4">
                <button onclick="fetchData()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4">Refresh Data</button>
            </div>
            <div id="data-table-container" class="overflow-x-auto">
                <p id="loading-status" class="text-center text-gray-500">Loading data...</p>
                <table id="food-table" class="w-full">
                    <thead>
                        <tr>
                            <th class="text-left">Name</th>
                            <th class="text-left">Quantity</th>
                            <th class="text-left">Owner</th>
                            <th class="text-left">Location</th>
                            <th class="text-left">Insertion</th>
                            <th class="text-left">Expiration</th>
                            <th class="text-left">Image</th>
                            <th class="text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <!-- === END PAGE 2 === -->

        <!-- === PAGE 3: CHAT (Hidden by default) === -->
        <div id="page-chat" class="page-content hidden">
            <hr class="my-10">
            <h2 class="text-2xl font-bold text-center mb-4">Pantry Assistant ü§ñ</h2>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" class="p-2 w-full" placeholder="Ask about your pantry..." required>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4">Send</button>
                </form>
            </div>
        </div>
        <!-- === END PAGE 3 === -->

    </div>

    <script>
        const messageContainer = document.getElementById('message-container');
        let locationsData = [];
        let attachmentsData = [];
        let allFoodData = [];
        
        const config = {
            backendUrl: window.location.origin,
            gristImageUrlBase: 'https://grist.home.jjluk.net',
            docId: '3bkG8senLEgK8n7df8U9vW',
        };
        
        function showMessage(message) {
            const backdrop = document.createElement('div');
            backdrop.className = 'backdrop';
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            messageBox.innerHTML = `
                <p class="text-lg font-semibold">${message}</p>
                <div class="mt-4 flex justify-end">
                    <button class="ok-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-800">OK</button>
                </div>
            `;
            
            messageBox.querySelector('.ok-btn').addEventListener('click', () => {
                messageBox.remove();
                backdrop.remove();
            });

            messageContainer.appendChild(backdrop);
            messageContainer.appendChild(messageBox);
        }

        function showConfirm(message, onConfirm) {
            const backdrop = document.createElement('div');
            backdrop.className = 'backdrop';
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            messageBox.innerHTML = `
                <p class="text-lg font-semibold">${message}</p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button class="cancel-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-800">Cancel</button>
                    <button class="confirm-btn px-4 py-2 rounded-lg bg-red-500 text-white">Delete</button>
                </div>
            `;

            const close = () => {
                messageBox.remove();
                backdrop.remove();
            };

            messageBox.querySelector('.cancel-btn').addEventListener('click', close);
            messageBox.querySelector('.confirm-btn').addEventListener('click', () => {
                onConfirm();
                close();
            });

            messageContainer.appendChild(backdrop);
            messageContainer.appendChild(messageBox);
        }

        function formatDateFromTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const d = new Date(timestamp * 1000);
            const year = d.getUTCFullYear();
            const month = d.getUTCMonth() + 1;
            const day = d.getUTCDate();
            return `${month}/${day}/${year}`;
        }

        function convertDateToISO(dateString) {
            if (!dateString || dateString === 'N/A') return '';
            const parts = dateString.split('/');
            return parts.length === 3 ? `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}` : '';
        }

        async function fetchApi(endpoint, options = {}) {
            const response = await fetch(`${config.backendUrl}/api${endpoint}`, options);
            if (!response.ok) {
                const errorBody = await response.text();
                const error = new Error(`HTTP error! Status: ${response.status} on ${endpoint}. Response: ${errorBody}`);
                error.response = response;
                throw error;
            }
            // For multipart form data, the response might not be JSON
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            }
            return response.text();
        }

        async function fetchLocations() {
            try {
                const data = await fetchApi('/locations');
                locationsData = data.records;
            } catch (error) {
                console.error(`API Error in fetchLocations:`, error.message);
                showMessage(`Failed to load locations. Check console for details.`);
            }
        }

        async function fetchAttachments() {
            try {
                const data = await fetchApi('/attachments');
                attachmentsData = data.records;
            } catch (error) {
                console.error(`API Error in fetchAttachments:`, error.message);
                showMessage(`Failed to load image library. Check console for details.`);
            }
        }
        
        function populateImageDropdown(selectElement, selectedId = null) {
            selectElement.innerHTML = '<option value="">-- No Image --</option>';
            attachmentsData.forEach(att => {
                const option = document.createElement('option');
                option.value = att.id;
                option.textContent = att.fields.fileName;
                if (selectedId && att.id == selectedId) option.selected = true;
                selectElement.appendChild(option);
            });
        }
        
        function populateLocationsDropdown(selectElement, selectedId = null) {
            selectElement.innerHTML = '<option value="" disabled>-- Select Location --</option>';
            locationsData.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.id;
                option.textContent = loc.fields.Name;
                if (selectedId && loc.id == selectedId) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
            if (locationsData.length > 0 && !selectedId) {
                selectElement.value = "";
            }
            selectElement.innerHTML += '<option value="new" class="font-bold text-blue-600">-- Add New Location --</option>';
        }

        async function createNewLocation(locationName) {
            try {
                const data = await fetchApi('/locations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Name: locationName })
                });
                return data.records[0].id; 
            } catch (error) {
                console.error(`API Error in createNewLocation:`, error.message);
                showMessage(`Failed to create new location. Check console for details.`);
                return null;
            }
        }

        async function uploadAttachment(file) {
            const formData = new FormData();
            formData.append('file', file);
            try {
                const data = await fetchApi('/attachments', { method: 'POST', body: formData });
                return data[0];
            } catch (error) {
                console.error(`API Error in uploadAttachment:`, error.message);
                showMessage(`Failed to upload image. Check console for details.`);
                return null;
            }
        }

        function renderTable(foodData) {
            const tableBody = document.querySelector('#food-table tbody');
            const loadingStatus = document.getElementById('loading-status');
            
            tableBody.innerHTML = '';

            if (!foodData || foodData.length === 0) {
                 if (allFoodData.length > 0) {
                    loadingStatus.textContent = 'No items match your search.';
                } else {
                    loadingStatus.textContent = 'No food items found.';
                }
                return;
            }
            
            loadingStatus.textContent = '';

            foodData.forEach(record => {
                const row = tableBody.insertRow();
                const { id, fields } = record;
                row.dataset.rowId = id;
                row.dataset.locationId = fields.Location;
                row.dataset.imageId = fields.Image ? fields.Image[1] : '';

                const insertionDate = formatDateFromTimestamp(fields.Insertion);
                const expirationDate = formatDateFromTimestamp(fields.Expiration);
                const locationName = locationsData.find(loc => loc.id === fields.Location)?.fields.Name || 'N/A';
                const imageId = fields.Image ? fields.Image[1] : null;
                const imageUrl = imageId ? `${config.gristImageUrlBase}/api/docs/${config.docId}/attachments/${imageId}/download` : null;

                row.innerHTML = `
                    <td>${fields.Name || 'N/A'}</td>
                    <td class="text-right">${fields.Quantity || 0}</td>
                    <td>${fields.Owner || 'N/A'}</td>
                    <td>${locationName}</td>
                    <td>${insertionDate}</td>
                    <td>${expirationDate}</td>
                    <td>${imageUrl ? `<a href="${imageUrl}" target="_blank" class="text-blue-500 hover:underline">View Image</a>` : 'N/A'}</td>
                    <td>
                        <div class="flex space-x-2">
                            <button class="edit-btn text-white py-1 px-3 rounded-lg text-sm">Edit</button>
                            <button class="delete-btn text-white py-1 px-3 rounded-lg text-sm">Delete</button>
                        </div>
                    </td>
                `;
            });
        }

        async function fetchData() {
            const loadingStatus = document.getElementById('loading-status');
            document.getElementById('food-table').style.display = 'none';

            try {
                await Promise.all([fetchAttachments(), fetchLocations()]);
                
                populateLocationsDropdown(document.getElementById('locationSelect'));
                
                const data = await fetchApi('/food');
                allFoodData = data.records || [];
                
                renderTable(allFoodData);
                document.getElementById('food-table').style.display = 'table';

            } catch (error) {
                console.error(`API Error in fetchData:`, error.message);
                loadingStatus.textContent = `Error loading data. Check console for details.`;
            }
        }
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = allFoodData.filter(record => 
                record.fields.Name.toLowerCase().includes(searchTerm)
            );
            renderTable(filteredData);
        });

        document.getElementById('locationSelect').addEventListener('change', async (e) => {
            if (e.target.value === 'new') {
                const newLocationName = prompt('Enter the name for the new location:');
                if (newLocationName && newLocationName.trim() !== '') {
                    const newLocationId = await createNewLocation(newLocationName.trim());
                    if (newLocationId) {
                        await fetchLocations();
                        populateLocationsDropdown(e.target, newLocationId);
                    }
                } else {
                    e.target.value = "";
                }
            }
        });

        document.getElementById('imageUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // --- UPDATED LOGIC ---
            // Only run AI analysis if the toggle is checked
            const aiToggleCheckbox = document.getElementById('aiToggle');
            if (!aiToggleCheckbox.checked) return;

            const aiStatus = document.getElementById('ai-status');
            aiStatus.textContent = 'Analyzing image...';

            const formData = new FormData();
            formData.append('image', file);

            try {
                // 'data' is now the *actual* JSON object: { item: "...", ... }
                // NOT { "result": "..." }
                const data = await fetchApi('/analyzeImage', {
                    method: 'POST',
                    body: formData,
                });
                
                console.log('Parsed JSON from server:', data);

                if (data && data.item) {
                    document.getElementById('name').value = data.item;
                    aiStatus.textContent = `‚úì Item identified as ${data.item}.`;
                } else {
                    aiStatus.textContent = '‚úì Could not identify item name.';
                }

                if (data && data.expiration_days) {
                    const days = parseInt(data.expiration_days, 10);
                    const today = new Date();
                    const expirationDate = new Date(today.setDate(today.getDate() + days));
                    document.getElementById('expiration').value = expirationDate.toISOString().split('T')[0];
                } else {
                    // Handle case where expiration_days might be missing or null
                    console.log('No expiration days provided by AI.');
                }

            } catch (error) {
                console.error(`API Error in analyzeImage:`, error.message);
                aiStatus.textContent = '‚úó Image analysis error.';
            }
        });
        
        document.getElementById('addItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const locationId = document.getElementById('locationSelect').value;
            if (!locationId || locationId === 'new') {
                showMessage("Please select a valid location.");
                return;
            }
            
            const ownerName = document.getElementById('owner').value;
            localStorage.setItem('lastOwnerName', ownerName);

            const imageUploadInput = document.getElementById('imageUpload');
            let imageId = null;

            // --- UPDATED LOGIC ---
            // Upload the image if one is selected, regardless of the AI toggle.
            if (imageUploadInput.files[0]) {
                document.getElementById('loading-status').textContent = 'Uploading image...';
                imageId = await uploadAttachment(imageUploadInput.files[0]);
                if (imageId === null) {
                    document.getElementById('loading-status').textContent = 'Error during image upload.';
                    return;
                }
                document.getElementById('loading-status').textContent = '';
            }

            const newItem = {
                Name: document.getElementById('name').value,
                Quantity: parseInt(document.getElementById('quantity').value, 10),
                Owner: ownerName,
                Location: parseInt(locationId, 10),
                Insertion: document.getElementById('insertion').value,
                Expiration: document.getElementById('expiration').value,
                Image: imageId ? ["L", imageId] : null
            };

            try {
                await fetchApi('/food', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newItem)
                });

                document.getElementById('addItemForm').reset();
                document.getElementById('ai-status').textContent = '';
                // After reset, we must also reset the toggle to its default "off" state
                setAIToggle(false);
                
                const today = new Date();
                document.getElementById('insertion').value = today.toISOString().split('T')[0];
                const weekFromToday = new Date(new Date().setDate(today.getDate() + 7));
                document.getElementById('expiration').value = weekFromToday.toISOString().split('T')[0];
                document.getElementById('quantity').value = 1;
                document.getElementById('owner').value = localStorage.getItem('lastOwnerName') || '';

                await fetchData();
            } catch (error) {
                console.error(`API Error in addItemForm submit:`, error.message);
                showMessage(`Failed to add item. Check console for details.`);
            }
        });

        function appendChatMessage(message, sender) {
            const messagesDiv = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            
            if (sender === 'user') {
                bubble.textContent = message; // User input is always plain text
            } else {
                // Parse AI input as Markdown and add Tailwind's 'prose'
                // classes for nice formatting of lists, bolding, etc.
                bubble.innerHTML = marked.parse(message);
                bubble.classList.add('prose', 'prose-sm', 'max-w-none');
            }
            
            messagesDiv.appendChild(bubble);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const chatButton = document.querySelector('#chat-form button');
            const messagesDiv = document.getElementById('chat-messages');
            
            const message = chatInput.value.trim();
            if (!message) return;

            appendChatMessage(message, 'user');
            chatInput.value = '';
            chatButton.disabled = true; // Disable send button

            // Append a new 'ai' bubble and hold a reference to it
            appendChatMessage('Thinking...', 'ai');
            const aiBubble = messagesDiv.querySelector('.ai-bubble:last-child');

            try {
                const itemsForApi = allFoodData.map(record => record.fields);

                // We use fetch() directly to read the stream
                const response = await fetch(`${config.backendUrl}/api/pantryChat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: itemsForApi,
                        message: message
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                }

                // --- UPDATED Stream Handling ---
                aiBubble.textContent = ''; // Clear "Thinking..."
                let rawMarkdown = ''; // Store the raw markdown string
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break; // Stream finished

                    const chunk = decoder.decode(value, { stream: true });
                    rawMarkdown += chunk; // Append raw text
                    
                    // Re-parse the entire markdown string on each chunk
                    aiBubble.innerHTML = marked.parse(rawMarkdown); 
                    messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
                }
                // --- End Stream Handling ---

            } catch (error) {
                console.error("API Error in pantryChat:", error.message);
                if (aiBubble.textContent === 'Thinking...' || aiBubble.textContent === '') {
                    // Use textContent for errors, no need to parse
                    aiBubble.textContent = 'An error occurred. Please try again.';
                }
            } finally {
                chatButton.disabled = false; // Re-enable send button
            }
        });

        document.getElementById('food-table').addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row) return;
            if (e.target.classList.contains('edit-btn')) makeRowEditable(row);
            else if (e.target.classList.contains('delete-btn')) showConfirm('Are you sure you want to delete this item?', () => deleteItem(row));
            else if (e.target.classList.contains('save-btn')) updateItem(row);
            else if (e.target.classList.contains('cancel-btn')) fetchData();
        });

        function makeRowEditable(row) {
            const cells = Array.from(row.cells);

            [0, 1, 2].forEach(i => {
                const input = document.createElement('input');
                input.type = i === 1 ? 'number' : 'text';
                input.value = cells[i].textContent.trim();
                input.className = 'p-2 rounded-lg border w-full';
                cells[i].innerHTML = '';
                cells[i].appendChild(input);
            });

            [4, 5].forEach(i => {
                const input = document.createElement('input');
                input.type = 'date';
                input.value = convertDateToISO(cells[i].textContent.trim());
                input.className = 'p-2 rounded-lg border w-full';
                cells[i].innerHTML = '';
                cells[i].appendChild(input);
            });

            const locationCell = cells[3];
            const originalLocationId = row.dataset.locationId;
            locationCell.innerHTML = '';
            const locationSelect = document.createElement('select');
            locationSelect.className = 'p-2 w-full border-gray-300 rounded-lg';
            populateLocationsDropdown(locationSelect, originalLocationId);
            locationCell.appendChild(locationSelect);
            
            locationSelect.addEventListener('change', async (e) => {
                if (e.target.value === 'new') {
                    const newLocationName = prompt('Enter the name for the new location:');
                    if (newLocationName && newLocationName.trim() !== '') {
                        const newLocationId = await createNewLocation(newLocationName.trim());
                        if (newLocationId) {
                            await fetchLocations();
                            populateLocationsDropdown(locationSelect, newLocationId);
                        }
                    } else {
                        locationSelect.value = originalLocationId || "";
                    }
                }
            });

            const imageCell = cells[6];
            const originalImageId = row.dataset.imageId;
            imageCell.innerHTML = '';
            const select = document.createElement('select');
            select.className = 'p-2 w-full border-gray-300 rounded-lg mb-2';
            populateImageDropdown(select, originalImageId);
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.className = 'p-2 w-full border-gray-300 rounded-lg';
            imageCell.append(select, fileInput);

            cells[7].innerHTML = `
                <div class="flex space-x-2">
                    <button class="save-btn text-white py-1 px-3 rounded-lg text-sm">Save</button>
                    <button class="cancel-btn text-white py-1 px-3 rounded-lg text-sm">Cancel</button>
                </div>
            `;
        }
        
        async function updateItem(row) {
            const rowId = row.dataset.rowId;
            const cells = row.cells;
            
            const imageFileInput = cells[6].querySelector('input[type="file"]');
            const imageSelectInput = cells[6].querySelector('select');
            let imageId = null;

            if (imageFileInput.files[0]) {
                document.getElementById('loading-status').textContent = 'Uploading image...';
                imageId = await uploadAttachment(imageFileInput.files[0]);
                if (imageId === null) {
                    document.getElementById('loading-status').textContent = 'Error uploading image.';
                    return;
                }
                document.getElementById('loading-status').textContent = '';
            } else if (imageSelectInput.value) {
                imageId = parseInt(imageSelectInput.value, 10);
            }
            
            const locationId = cells[3].querySelector('select').value;
             if (!locationId || locationId === 'new') {
                showMessage("Please select a valid location for the update.");
                return;
            }

            const updatedFields = {
                Name: cells[0].querySelector('input').value,
                Quantity: parseInt(cells[1].querySelector('input').value, 10),
                Owner: cells[2].querySelector('input').value,
                Location: parseInt(locationId, 10),
                Insertion: cells[4].querySelector('input').value,
                Expiration: cells[5].querySelector('input').value,
                Image: imageId ? ["L", imageId] : null
            };

            try {
                await fetchApi(`/food/${rowId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedFields)
                });
                await fetchData();
            } catch (error) {
                console.error(`API Error in updateItem:`, error.message);
                showMessage(`Failed to update item. Check console for details.`);
            }
        }

        async function deleteItem(row) {
            const rowId = row.dataset.rowId;
            try {
                // Use default axios config for this one, as it sends JSON
                await fetchApi(`/food/${rowId}`, { method: 'DELETE' });
                await fetchData();
            } catch (error) {
                // Check if the error is the 400 we've been seeing
                if (error.response && error.response.status === 400) {
                    console.warn('Delete succeeded but attachment cleanup failed (400). Refreshing data.');
                    await fetchData(); // Refresh data even if cleanup fails
                } else {
                    console.error(`API Error in deleteItem:`, error.message);
                    showMessage(`Failed to delete item. Check console for details.`);
                }
            }
        }

        document.getElementById('insertion').addEventListener('input', (e) => {
            try {
                const insertionDateValue = e.target.value;
                if (insertionDateValue) {
                    const parts = insertionDateValue.split('-');
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    
                    const insertionDate = new Date(year, month, day);
                    const expirationDate = new Date(new Date(insertionDate).setDate(insertionDate.getDate() + 7));
                    document.getElementById('expiration').value = expirationDate.toISOString().split('T')[0];
                }
            } catch (error) {
                console.error("Could not parse date:", error);
                document.getElementById('expiration').value = '';
            }
        });

        // --- NEW AI TOGGLE SCRIPT ---
        const aiToggleBtn = document.getElementById('aiToggleBtn');
        const aiToggleCheckbox = document.getElementById('aiToggle');
        const aiToggleHandle = document.getElementById('aiToggleHandle');
        const aiImageUploadInput = document.getElementById('imageUpload');
        const aiStatus = document.getElementById('ai-status');

        // Helper function to set toggle state
        function setAIToggle(isOn) {
            aiToggleCheckbox.checked = isOn;
            aiToggleBtn.setAttribute('aria-checked', isOn);
            if (isOn) {
                aiToggleBtn.classList.remove('bg-gray-200');
                aiToggleBtn.classList.add('bg-indigo-600');
                aiToggleHandle.classList.remove('translate-x-0');
                aiToggleHandle.classList.add('translate-x-5');
                // aiImageUploadInput.disabled = false; // No longer disabled
            } else {
                aiToggleBtn.classList.add('bg-gray-200');
                aiToggleBtn.classList.remove('bg-indigo-600');
                aiToggleHandle.classList.add('translate-x-0');
                aiToggleHandle.classList.remove('translate-x-5');
                // aiImageUploadInput.disabled = true; // No longer disabled
                aiStatus.textContent = ''; // Clear AI status when turning off
            }
        }

        aiToggleBtn.addEventListener('click', () => {
            const isChecked = !aiToggleCheckbox.checked; // Get the new state
            setAIToggle(isChecked);
        });
        // --- END AI TOGGLE SCRIPT ---


        // --- TAB NAVIGATION SCRIPT ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const pageContents = document.querySelectorAll('.page-content');

        function showPage(pageId) {
            // 1. Hide all page containers
            pageContents.forEach(page => {
                page.classList.add('hidden');
            });
            
            // 2. Deactivate all tab buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            // 3. Show the target page
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            
            // 4. Activate the target tab button
            const targetTab = document.querySelector(`.tab-btn[data-page="${pageId}"]`);
            if (targetTab) {
                targetTab.classList.add('border-indigo-500', 'text-indigo-600');
                targetTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            }
        }

        // 5. Attach click listeners to all tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showPage(button.dataset.page);
            });
        });
        // --- END TAB LOGIC ---

        window.onload = () => {
            const today = new Date();
            document.getElementById('insertion').value = today.toISOString().split('T')[0];
            const weekFromToday = new Date(new Date().setDate(today.getDate() + 7));
            document.getElementById('expiration').value = weekFromToday.toISOString().split('T')[0];
            
            document.getElementById('quantity').value = 1;
            document.getElementById('owner').value = localStorage.getItem('lastOwnerName') || '';

            fetchData();
            
            // 6. Set the default page to show on load
            showPage('add'); 
        };
    </script>
</body>
</html>